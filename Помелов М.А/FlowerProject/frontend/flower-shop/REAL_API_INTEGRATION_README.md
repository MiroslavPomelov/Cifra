# Интеграция с реальными API

## Обзор

Система теперь интегрирована с реальными backend сервисами:
- **order-service** - управление заказами
- **payment-service** - обработка платежей
- **API Gateway** - маршрутизация запросов

## Архитектура

### Backend сервисы

1. **order-service** (C# .NET)
   - Создание заказов
   - Получение истории заказов
   - Обновление статусов заказов
   - Статистика заказов

2. **payment-service** (C# .NET)
   - Обработка платежей по картам
   - Валидация данных карт
   - Статистика платежей
   - Безопасное хранение данных

3. **API Gateway** (NestJS)
   - Маршрутизация запросов к сервисам
   - Аутентификация и авторизация
   - Логирование и мониторинг

### Frontend интеграция

1. **API Service** (`/services/api.ts`)
   - Методы для работы с order-service
   - Методы для работы с payment-service
   - Обработка ошибок и fallback

2. **PaymentForm** (`/checkout/components/PaymentForm.tsx`)
   - Форма ввода данных карты
   - Валидация на клиенте
   - Интеграция с payment-service

3. **Checkout Page** (`/checkout/page.tsx`)
   - Двухэтапный процесс оформления
   - Интеграция с order-service
   - Обработка платежей

## API Endpoints

### Order Service

```
POST /order - Создание заказа
GET /order/user/{userId} - Получение заказов пользователя
GET /order/{orderId} - Получение заказа по ID
PUT /order/{orderId}/status - Обновление статуса заказа
GET /order/statistics - Статистика заказов
```

### Payment Service

```
POST /payment - Создание платежа
POST /payment/validate-card - Валидация карты
GET /payment/{paymentId} - Получение платежа по ID
GET /payment/statistics - Статистика платежей
```

## Процесс оформления заказа

### 1. Заполнение формы
- Контактная информация
- Адрес доставки
- Способ доставки
- Способ оплаты

### 2. Оплата (если выбрана карта)
- Ввод данных карты
- Валидация на клиенте
- Отправка в payment-service
- Обработка результата

### 3. Создание заказа
- Отправка данных в order-service
- Сохранение локально как fallback
- Очистка корзины
- Перенаправление в профиль

## Безопасность

### Платежные данные
- CVC код не сохраняется в базе
- Номер карты маскируется
- SSL-шифрование всех запросов
- Валидация на клиенте и сервере

### Аутентификация
- JWT токены для всех запросов
- Проверка авторизации в API Gateway
- Защищенные endpoints

## Обработка ошибок

### API недоступен
1. **Создание заказа**: Сохранение локально
2. **Оплата**: Показ ошибки пользователю
3. **Просмотр заказов**: Использование локальных данных

### Ошибки валидации
1. **Клиентская валидация**: Мгновенная обратная связь
2. **Серверная валидация**: Детальные сообщения об ошибках
3. **Fallback**: Локальное сохранение при ошибках API

## Запуск системы

### 1. Backend сервисы
```bash
# В корневой папке backend
docker-compose up -d
```

### 2. Frontend
```bash
# В папке frontend/flower-shop
npm run dev
```

### 3. Проверка работоспособности
```bash
# Проверка API Gateway
curl http://localhost:3000/health

# Проверка order-service
curl http://localhost:3000/order/health

# Проверка payment-service
curl http://localhost:3000/payment/health
```

## Тестирование

### Тестовые данные карт
```
Visa: 4111111111111111
MasterCard: 5555555555554444
CVC: 123
Срок действия: 12/25
```

### Создание тестового заказа
1. Добавьте товары в корзину
2. Перейдите к оформлению заказа
3. Заполните форму
4. Выберите оплату картой
5. Введите тестовые данные
6. Подтвердите оплату

## Мониторинг

### Логи
- API Gateway: Логирует все запросы
- Order Service: Логирует операции с заказами
- Payment Service: Логирует платежные операции

### Метрики
- Количество заказов
- Успешность платежей
- Время ответа сервисов
- Ошибки и исключения

## Расширение функциональности

### Возможные улучшения
1. **Уведомления**: Email/SMS о статусе заказа
2. **Отслеживание**: Интеграция со службами доставки
3. **Возвраты**: Система возврата товаров
4. **Отзывы**: Отзывы о заказах
5. **Повторные заказы**: Кнопка "Заказать снова"

### Интеграции
1. **Банковские системы**: Реальные платежные шлюзы
2. **Службы доставки**: API для отслеживания
3. **SMS/Email сервисы**: Уведомления клиентов
4. **Аналитика**: Системы аналитики и отчетности

## Troubleshooting

### Частые проблемы

1. **API Gateway недоступен**
   - Проверьте Docker контейнеры
   - Проверьте порты и сеть
   - Проверьте логи контейнеров

2. **Ошибки аутентификации**
   - Проверьте JWT токен
   - Проверьте настройки авторизации
   - Проверьте envservicetoken

3. **Ошибки платежей**
   - Проверьте данные карты
   - Проверьте подключение к payment-service
   - Проверьте логи платежей

### Полезные команды
```bash
# Просмотр логов
docker-compose logs -f api-gateway
docker-compose logs -f order-service
docker-compose logs -f payment-service

# Перезапуск сервисов
docker-compose restart api-gateway
docker-compose restart order-service
docker-compose restart payment-service

# Проверка статуса
docker-compose ps
```
